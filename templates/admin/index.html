{% extends 'admin/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="p-6 space-y-8 bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">

  <!-- Statistika kartalari -->
  <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6">

    <!-- Foydalanuvchilar -->
    <div class="stat-card">
      <div class="text-3xl">ğŸ‘¥</div>
      <h3>Foydalanuvchilar</h3>
      <p class="stat-value text-blue-600 dark:text-blue-400">{{ stats.total_users }}</p>
    </div>

    <!-- Premium foydalanuvchilar -->
    <div class="stat-card">
      <div class="text-3xl">ğŸ’</div>
      <h3>Premium foydalanuvchilar</h3>
      <p class="stat-value text-purple-600 dark:text-purple-400">{{ stats.premium_users }}</p>
    </div>

    <!-- Aktiv foydalanuvchilar -->
    <div class="stat-card">
      <div class="text-3xl">âœ…</div>
      <h3>Aktiv foydalanuvchilar</h3>
      <p class="stat-value text-green-600 dark:text-green-400">{{ stats.active_users }}</p>
    </div>

    <!-- Kinolar -->
    <div class="stat-card">
      <div class="text-3xl">ğŸ¬</div>
      <h3>Kinolar</h3>
      <p class="stat-value text-yellow-600 dark:text-yellow-400">{{ stats.total_movies }}</p>
    </div>

    <!-- Sharhlar -->
    <div class="stat-card">
      <div class="text-3xl">ğŸ’¬</div>
      <h3>Sharhlar</h3>
      <p class="stat-value text-red-600 dark:text-red-400">{{ stats.total_reviews }}</p>
    </div>

    <!-- Bookmarks -->
    <div class="stat-card">
      <div class="text-3xl">ğŸ”–</div>
      <h3>Bookmarks</h3>
      <p class="stat-value text-indigo-600 dark:text-indigo-400">{{ stats.total_bookmarks }}</p>
    </div>
  </div>

  <!-- 2 ta chart yonma-yon -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
    <!-- Foydalanuvchilar foizi (dumaloq diagramma) -->
    <div class="stat-card">
      <h2 class="text-xl font-bold mb-4">ğŸ‘¥ Foydalanuvchilar taqsimoti</h2>
      <div class="relative h-72 w-72 mx-auto">
        <canvas id="usersPieChart"></canvas>
      </div>
    </div>

    <!-- User Activity (Line Chart) -->
    <div class="stat-card">
      <h2 class="text-xl font-bold mb-4">ğŸ“ˆ Soâ€˜nggi 7 kun Aktiv foydalanuvchilar</h2>
      <canvas id="userActivityChart" height="150"></canvas>
    </div>
  </div>

  <!-- Top 5 kinolar diagram -->
  <div class="stat-card mt-6">
    <h2 class="text-xl font-bold mb-4">ğŸ† Top 5 kinolar (reyting bo'yicha)</h2>
    <canvas id="topMoviesChart" height="120"></canvas>
  </div>

</div>

<!-- JSON data -->
{{ top_movies|json_script:"top_movies_data" }}
{{ user_activity|json_script:"user_activity_data" }}

<!-- Tailwind bilan umumiy style -->
<style>
  .stat-card {
    @apply shadow-lg rounded-2xl p-6 text-center transition bg-white dark:bg-gray-800 hover:shadow-2xl transform hover:-translate-y-1 hover:scale-105 duration-300;
  }
  .stat-card h3 {
    @apply text-gray-600 dark:text-gray-300 mt-2 text-sm uppercase tracking-wide;
  }
  .stat-card .stat-value {
    @apply text-3xl font-extrabold mt-1;
  }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const topMovies = JSON.parse(document.getElementById('top_movies_data').textContent);
  const labels = topMovies.map(m => m.title);
  const ratings = topMovies.map(m => m.avg_rating);

  const ctx = document.getElementById('topMoviesChart').getContext('2d');
  const usersCtx = document.getElementById('usersPieChart').getContext('2d');
  const activityCtx = document.getElementById('userActivityChart').getContext('2d');

  // Ranglarni dark/light rejimga mos qilish
  function getChartColors() {
    const isDark = document.documentElement.classList.contains("dark");
    return {
      text: isDark ? "#f9fafb" : "#111827",
      grid: isDark ? "#4b5563" : "#e5e7eb",
    };
  }

  let chartColors = getChartColors();

  // Bar chart (Top kinolar)
  let chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "O'rtacha reyting",
        data: ratings,
        backgroundColor: 'rgba(59, 130, 246, 0.7)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: chartColors.text } }
      },
      scales: {
        x: {
          ticks: { color: chartColors.text },
          grid: { color: chartColors.grid }
        },
        y: {
          beginAtZero: true,
          max: 5,
          ticks: { color: chartColors.text },
          grid: { color: chartColors.grid }
        }
      }
    }
  });

  // Pie chart (foydalanuvchilar foizi)
  let usersPie = new Chart(usersCtx, {
    type: 'doughnut',
    data: {
      labels: ["Premium", "Oddiy"],
      datasets: [{
        data: [
          {{ stats.premium_users }},
          {{ stats.total_users|default:0 }} - {{ stats.premium_users|default:0 }}
        ],
        backgroundColor: [
          'rgba(139, 92, 246, 0.7)',
          'rgba(59, 130, 246, 0.7)'
        ],
        borderColor: [
          'rgba(139, 92, 246, 1)',
          'rgba(59, 130, 246, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: chartColors.text } }
      }
    }
  });

  // Line chart (User Activity - soâ€˜nggi 7 kun)
  const activityData = JSON.parse(document.getElementById('user_activity_data').textContent);
  let userActivityChart = new Chart(activityCtx, {
    type: 'line',
    data: {
      labels: activityData.labels,   // masalan: ["Dush", "Sesh", ...]
      datasets: [{
        label: "Aktiv foydalanuvchilar",
        data: activityData.data,    // masalan: [5, 7, 3, 9, 6, 4, 8]
        borderColor: 'rgba(34,197,94,1)',   // green
        backgroundColor: 'rgba(34,197,94,0.2)',
        fill: true,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 4,
        pointBackgroundColor: 'rgba(34,197,94,1)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: chartColors.text } }
      },
      scales: {
        x: {
          ticks: { color: chartColors.text },
          grid: { color: chartColors.grid }
        },
        y: {
          beginAtZero: true,
          ticks: { color: chartColors.text },
          grid: { color: chartColors.grid }
        }
      }
    }
  });

  // Tema oâ€˜zgarsa chartlarni yangilash
  const observer = new MutationObserver(() => {
    chartColors = getChartColors();

    chart.options.plugins.legend.labels.color = chartColors.text;
    chart.options.scales.x.ticks.color = chartColors.text;
    chart.options.scales.y.ticks.color = chartColors.text;
    chart.options.scales.x.grid.color = chartColors.grid;
    chart.options.scales.y.grid.color = chartColors.grid;
    chart.update();

    usersPie.options.plugins.legend.labels.color = chartColors.text;
    usersPie.update();

    userActivityChart.options.plugins.legend.labels.color = chartColors.text;
    userActivityChart.options.scales.x.ticks.color = chartColors.text;
    userActivityChart.options.scales.y.ticks.color = chartColors.text;
    userActivityChart.options.scales.x.grid.color = chartColors.grid;
    userActivityChart.options.scales.y.grid.color = chartColors.grid;
    userActivityChart.update();
  });

  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>
{% endblock %}
